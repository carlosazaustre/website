---
title: "JavaScript Promises. Uso de promesas en AngularJS"
date: "2015-04-27"
tags:
  - " Desarrollo"
---

Las promesas son **objetos de JavaScript** que sustituyen de alguna manera a los callbacks. Se utilizan cuando no se puede retornar el valor de una funci贸n porque a煤n no se conoce, pero no podemos dejar que bloqueen la funci贸n esperando a que llegue. El objeto promesa en un futuro contendr谩 el valor que esperamos retornar. Es complicado de entender en un principio, pero si conocemos como funciona, en ocasiones nos puede resultar 煤til.

Hay que indicar que una **Promesa** no nos sustituye el hecho de utilizar callbacks para leer su valor, pero lo que nos evita es caer en el temido _Callback Hell_.

```javascript
obj.metodo1(data, function (data1) {
  obj.metodo2(data1, function (data2) {
    obj.metodo3(data2, function (data3) {
      obj.metodo4(data3, function (data4) {
        // Hasta el infinito y m谩s all谩
      });
    });
  });
});
```

Utilizaremos en su lugar los m茅todos `then()` y `catch()` para implementar la funcionalidad. El ejemplo del _Callback Hell_ anterior con promesas ser铆a de la siguiente manera:

```javascript
obj
 .metodo1(data)
 .then(obj.metodo2(data1))
 .then(obj.metodo3(data2)
 .then(obj.metodo4(data3))
 ...
```

Un uso adecuado para ello es en los servicios en AngularJS, usando la directiva o servicio del core de Angular `$q`, que contiene toda la funcionalidad de las promesas. Veamos un ejemplo.

Por ejemplo, supongamos que tenemos un controlador `myController` de una vista de nuestra aplicaci贸n angular que llame a un recurso a trav茅s de un API con el m茅todo `GET`:

```javascript
function MyController($scope, $http) {
  $http.get("http://midominio.com/recursos.json").success(function (data) {
    $scope.elementos = data;
  });
}
```

Por buenas pr谩cticas y por separaci贸n de conceptos y tambi茅n para hacer nuestro c贸digo m谩s mantenible y escalable, debemos separar la l贸gica de nuestra aplicaci贸n (la llamada `$http`) en un servicio y el controlador dejarlo s贸lo para la conexi贸n entre nuestros servicios y la vista HTML.

Por tanto creamos un servicio `dataService` que se encarga de comunicarse con nuestro API y en 茅l haremos las llamadas HTTP.

La funci贸n dentro de nuestros servicio que nos devolver谩 todos los recursos (elementos) de nuestra base de datos a trav茅s de un supuesto API ser谩 la funci贸n `getAll`. En esta funci贸n haremos lo mismo que hac铆amos en el controlador pero utilizando el objecto `$q` de AngularJS para crear promesas (o "Promises").

Antes de hacer la llamada `HTTP GET` creamos un objeto que contendr谩 la promesa a devolver y el objeto `defered` que se usa dentro de la funci贸n as铆ncrona y tiene dos m茅todos que luego veremos `resolve()` y `reject()`.

```javascript
var defered = $q.defer();
var promise = defered.promise;
```

Seguidamente realizamos la llamada HTTP, y en el m茅todo `Success`, que nos devuelve los datos del servidor o API si la llamada ha finalizado correctamente, invocamos la funci贸n `resolve()` de nuestra promesa y le pasamos por argumentos los datos recibidos. ste m茅todo sirve para indicar que se ha obtenido la informaci贸n y pasarlo como par谩metro

```
defered.resolve(data);
```

En caso de que en nuestra llamada ocurriese un error, se llamar铆a a la funci贸n `Error`, en ese caso invocaremos a la funci贸n `reject()` de nuestra promesa, que indica que la petici贸n ha sido rechazada y se le pasa el error por par谩metro:

```
defered.reject(err);
```

Finalmente devolveremos el objecto promesa que creamos antes y ser谩 el que reciba el controlador:

```
return promise;
```

Nuestro servicio `dataService` quedar铆a as铆:

```javascript
function dataService($http, $q) {
  return {
    getAll: getAll,
  };

  function getAll() {
    var defered = $q.defer();
    var promise = defered.promise;

    $http
      .get("http://midominio.com/recursos.json")
      .success(function (data) {
        defered.resolve(data);
      })
      .error(function (err) {
        defered.reject(err);
      });

    return promise;
  }
}
```

Solamente nos queda inyectar ese servicio en nuestro controlador y llamar a la funci贸n `getAll()` y tratar la promesa con los m茅todos `then()` y `catch()` que se llaman cuando finalice la petici贸n o se produzca un error:

```javascript
function myController (dataService) {
    dataService
        .getAll()
        .then(function(data) {
            $scope.elementos = data;
        })
        .catch(function(err)) {
            // Tratar el error
        }
}
```

De esta manera tenemos separados los conceptos y las funcionalidades en nuestra aplicaci贸n Angular y utilizando promesas para devolver el resultado de nuestras peticiones.

Para ampliar m谩s esta informaci贸n, puedes visitar:

- [NodeSchool Workshopper - Promise It Won't Hurt](https://github.com/stevekane/promise-it-wont-hurt)
- [Promises/A+](https://promisesaplus.com/)
- [Q](http://documentup.com/kriskowal/q)
- [AngularJS DOCS: Servicio $q](https://docs.angularjs.org/api/ng/service/$q)
