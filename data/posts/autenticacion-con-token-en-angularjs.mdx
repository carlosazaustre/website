---
title: "C贸mo hacer autenticaci贸n basada en token con AngularJS"
date: "2015-02-26"
tags:
  - " Desarrollo"
---

Bienvenid@ a la 煤ltima entrega de la serie de **Autenticaci贸n basada en token en aplicaciones web**. En las anteriores entradas vimos las [bases de este m茅todo](/que-es-la-autenticacion-con-token/) y [c贸mo programarlo en nuestro servidor o API REST con Node.js](/autenticacion-con-token-en-node-js/). En 茅ste art铆culo veremos **como implementarlo en el lado del cliente con Angular.js**

#### Usando librer铆as de terceros

Podemos hacerlo de varias maneras. Implementarlo manualmente o utilizar una librer铆a que nos facilite el desarrollo. Yo recomiendo esto 煤ltimo y en concreto la **librer铆a [Satellizer](https://github.com/sahat/satellizer)**, desarrollada por [Sahat Yalkabov](http://sahatyalkabov.com/) que desarroll贸 durante su etapa de _non-student_ en la [Hacker School](https://www.hackerschool.com/) de Nueva York.

Esta librer铆a soporta autenticaci贸n por usuario/contrase帽a adem谩s de proveedores OAuth como Facebook, Twitter, Google, Github, etc... Es sencilla de usar y funciona perfectamente. A continuaci贸n veremos como configurarla.

#### Instalaci贸n y configuraci贸n

Primero necesitamos instalarla, podemos hacerlo por Bower o si usamos Browserify por NPM.

```
$ bower install --save satellizer
```

De seguido, en nuestro fichero principal de Angular, supongamos el `app.js`, importamos el m贸dulo y configuramos la librer铆a. El nombre de la directiva que utiliza _Satellizer_ es `$auth` y `$authProvider`.

```js
angular
	.module("myApp", ["satellizer"])
    .config(function($authProvider) {
    	// Parametros de configuraci贸n
        $authProvider.loginUrl = "http://api.com/auth/login";
        $authProvider.signupUrl = "http://api.com/auth/signup";
        $authProvider.tokenName = "token";
        $authProvider.tokenPrefix = "myApp",
    });
```

En `$authProvider.loginUrl` y `$authProvider.signupUrl` indicamos cual es la ruta de nuestro servidor o API REST que maneja la autenticaci贸n. Como vimos en el anterior post, 茅stas rutas on `/auth/login` y `/auth/signup`.

En `$authProvider.tokenName` le indicamos un nombre al token y `$authProvider.tokenPrefix` para a帽adirle un prefijo al nombre del token por si queremos diferenciarlo en nuestro LocalStorage de otros. En este caso, el token quedar谩 guardado en LocalStorage con la clave `myApp_token`.

#### Controladores

Lo siguiente a implementar son los controladores. Tendremos dos principalmente, el de login y el de registro, adem谩s del de logout.

```js
angular
	.module("myApp.controllers")
    .controller("SignUpController", SignUpController)
    .controller("LoginController", LoginController);
    .controller("LogoutController", LogoutController);

function SignUpController($auth, $location) {
	var vm = this;
    this.signup = function() {
    	$auth.signup({
        	email: vm.email,
            password: vm.password
        })
        .then(function() {
        	// Si se ha registrado correctamente,
            // Podemos redirigirle a otra parte
            $location.path("/private");
        })
        .catch(function(response) {
        	// Si ha habido errores, llegaremos a esta funci贸n
        });
    }
}

function LoginController($auth, $location) {
	var vm = this;
    this.login = function(){
    	$auth.login({
        	email: vm.email,
            password: vm.password
        })
        .then(function(){
        	// Si se ha logueado correctamente, lo tratamos aqu铆.
            // Podemos tambi茅n redirigirle a una ruta
            $location.path("/private")
        })
        .catch(function(response){
        	// Si ha habido errores llegamos a esta parte
        });
    }
}

function LogoutController($auth, $location) {
	$auth.logout()
    	.then(function() {
        	// Desconectamos al usuario y lo redirijimos
            $location.path("/")
        });
}
```

Es un c贸digo sencillo si ya has visto AngularJS anteriormente. Creamos las funciones correspondientes que utilizaremos desde las vistas `this.signup`, `this.login`. Estas funciones a su vez llamar谩n a la librer铆a _Satellizer_ a trav茅s de la directiva `$auth` llamando a las funciones `$auth.login()`, `$auth.signup()` y `$auth.logout()`.

Estas funciones por debajo, realizan todo el manejo de insertar en la cabecera HTTP el token de autenticaci贸n que recibe del servidor cuando se registra/autentica y que env铆a en cada petici贸n HTTP una vez autenticado.

#### 驴D贸nde se almacena el Token?

Vamos a ver un poco como est谩 hecho _Satellizer_ por dentro. Puedes mirarlo en su [repositorio en GitHub](https://github.com/sahat/satellizer/blob/master/satellizer.js) ya que es _OpenSource_, e incluso puedes ayudar a mejorarlo con tus aportes :)

Entre todos los m贸dulos que est谩n programados en _Satellizer_, vemos uno llamado `satellizer.shared` donde se comparten los m茅todos y funciones que utiliza el resto de la librer铆a. Digamos que 茅ste es el n煤cleo de la funcionalidad.

`shared.getToken()` busca en nuestro LocalStorage la clave que hemos definido para almacenar nuestro Token y nos lo devuelve

```js
shared.getToken = function () {
  var tokenName = config.tokenPrefix
    ? config.tokenPrefix + "_" + config.tokenName
    : config.tokenName;
  return $window.localStorage[tokenName];
};
```

`shared.getPayload()` toman el token y devuelve el `payload` que es la 2a parte del token

```js
shared.getPayload = function () {
  var tokenName = config.tokenPrefix
    ? config.tokenPrefix + "_" + config.tokenName
    : config.tokenName;
  var token = $window.localStorage[tokenName];

  if (token && token.split(".").length === 3) {
    var base64Url = token.split(".")[1];
    var base64 = base64Url.replace("-", "+").replace("_", "/");
    return JSON.parse($window.atob(base64));
  }
};
```

Y por 煤ltimo la funci贸n `shared.setToken()`, almacena el token recibido en el LocalStorage:

```js
shared.setToken = function (response, isLinking) {
  var token =
    response.access_token ||
    (config.tokenRoot && response.data[config.tokenRoot]
      ? response.data[config.tokenRoot][config.tokenName]
      : response.data[config.tokenName]);
  var tokenName = config.tokenPrefix
    ? config.tokenPrefix + "_" + config.tokenName
    : config.tokenName;

  if (!token) {
    tokenName = config.tokenRoot
      ? config.tokenRoot + "." + config.tokenName
      : config.tokenName;
    throw new Error(
      'Expecting a token named "' +
        tokenName +
        '" but instead got: ' +
        JSON.stringify(response.data)
    );
  }

  $window.localStorage[tokenName] = token;

  if (config.loginRedirect && !isLinking) {
    $location.path(config.loginRedirect);
  }
};
```

##### 驴C贸mo se env铆a el token en cada petici贸n HTTP?

De eso se encarga la directiva `$httpProvider` que funciona como interceptor o middleware y se activa en cada petici贸n HTTP.

```js
//...
.config(['$httpProvider', 'satellizer.config', function($httpProvider, config) {
      $httpProvider.interceptors.push(['$q', function($q) {
        var tokenName = config.tokenPrefix ? config.tokenPrefix + '_' + config.tokenName : config.tokenName;
        return {
          request: function(httpConfig) {
            var token = localStorage.getItem(tokenName);
            if (token && config.httpInterceptor) {
              token = config.authHeader === 'Authorization' ? 'Bearer ' + token : token;
              httpConfig.headers[config.authHeader] = token;
            }
            return httpConfig;
          },
          responseError: function(response) {
            return $q.reject(response);
          }
        };
      }]);
    }]);
```

De esta manera, en cada petici贸n HTTP, se inserta en las cabeceras el token si lo tenemos en el LocalStorage y ya despues el backend (nuestro servidor o API) se encarga de ver si existe, es correcto o no y devolver el c贸digo de respuesta para cada caso.

#### Rutas y vistas

Volvemos al m贸dulo principal de nuestra aplicaci贸n y a帽adimos las rutas del frontend a continuaci贸n de la configuraci贸n del `$authProvider` podemos usar `ngRoute` o `ui.route` si queremos tener estados en lugar de rutas y poder tener vistas anidadas (_nested views_). Yo suelo utilizar `ui.router` me parece m谩s c贸modo. Para ello primero instalamos la librer铆a correspondiente:

```shell
$ bower install --save angular-ui-router
```

Y lo configuramos en `app.js`

```js
angular
	.module("myApp", ["satellizer", "ui.router"])
    .config(function($authProvider, $stateProvider) {
    	// Parametros de configuraci贸n
        $authProvider.loginUrl = "http://api.com/auth/login";
        $authProvider.signupUrl = "http://api.com/auth/signup";
        $authProvider.tokenName = "token";
        $authProvider.tokenPrefix = "myApp",

        // Configuraci贸n de las rutas/estados
        $stateProvider
        	.state("home", {
            	url: "/",
                templateUrl: "views/index.html"
                controller: "HomeController"
            })
            .state("login", {
            	url: "/login",
                templateUrl: "views/login.html",
                controller: "LoginController",
                controllerAs: "login"
            })
            .state("signup", {
            	url: "/signup",
                templateUrl: "views/signup.html",
                controller: "SignUpController",
                controllerAs: "signup"
            })
            .state("logout", {
            	url: "/logout",
                templateUrl: null,
                controller: "LogoutController"
            })
            .state("private", {
            	url: "/private",
                templateUrl: "views/private.html",
                controller: "PrivateController",
                controllerAs: "private"
            });
    });
```

En este c贸digo he configurado dos rutas adicionales, la de `Home` en `/` y la de `Private` en `/private` pero 茅stas no las voy a desarrollar en este ejemplo. Esas ya son propias de tu aplicaci贸n.

Lo que si voy a mostrar es como ser铆an las vistas para el `login` y el `signup`.

```html
<!-- views/signup.html -->
<form ng-submit="signup.signup()" method="post">
  <input type="email" ng-model="signup.email" />
  <input type="password" ng-model="signup.password" />
  <button type="submit">Registrarse</button>
</form>
```

```html
<!-- views/login.html -->
<form ng-submit="login.login()" method="post">
  <input type="email" ng-model="login.email" />
  <input type="password" ng-model="login.password" />
  <button type="submit">Autenticarse</button>
</form>
```

En ellas vemos los `ng-model` que utilizamos y que obtenemos en el controlador.

Si quieres m谩s informaci贸n (en ingl茅s) sobre estos temas de autenticaci贸n por Token, te dejo unos enlaces a blogs y websites que me han servido para documentarme y aprender a manejar este sistema.

**Fuentes**

- [Cookies vs Tokens. Getting Auth right with Angular.js](https://auth0.com/blog/2014/01/07/angularjs-authentication-with-cookies-vs-token/)
- [The Anatomy of a JSON Web Token](https://scotch.io/tutorials/the-anatomy-of-a-json-web-token)
- [The Ins and Outs of token based authentication](https://scotch.io/tutorials/the-ins-and-outs-of-token-based-authentication)
- [Token-based authentication with AngularJS and NodeJS](http://code.tutsplus.com/tutorials/token-based-authentication-with-angularjs-nodejs--cms-22543)
