---
title: "C√≥mo crear un API REST usando Node.js, Express y MongoDB"
banner: "/images/como-crear-una-api-rest-usando-node-js/api-res-node-seo.jpg"
date: "2017-09-21"
tags:
  - "üíª Desarrollo"
---

<YouTube playlist="PLUdlARNXMVkk7E88zOrphPyGdS50Tadlr" />

El primer paso para implementar un <a href="/desarrollo-full-stack-javascript-tambien-conocido-como-mean/">sitio web moderno</a> es la construcci√≥n de un API REST que podemos consumir desde una aplicaci√≥n web, mobile o nativa.

En √©ste tutorial explicar√© como desarrollar servidor web que sirva una <a href="http://en.wikipedia.org/wiki/REST_API">API RESTful</a> usando para ello la tecnolog√≠a de <a href="http://nodejs.org/">Node.js</a> y <a href="http://www.mongodb.org/">MongoDB</a> como base de datos. Es el llamado <b>MEAN Stack</b> Tambi√©n es una buena opci√≥n para empezar y aprender Node.js desde cero.

Como framework para Node, voy a emplear **Express** en su versi√≥n 4.x y para conectarme a Mongo y mapear los modelos de datos, utilizar√© [Mongoose](http://mongoosejs.com/).

Una API RESTful es aquella que emplea todos los verbos HTTP (GET, POST, PUT y DELETE mayormente) Como ejemplo para este tutorial, desarrollar√© una aplicaci√≥n [**CRUD** (Create/Read/Update/Delete)](http://en.wikipedia.org/wiki/Create,_read,_update_and_delete) que utiliza todos los verbos HTTP, para mostrar como trabaja. Vamos all√°!

## Cambios en Express versi√≥n 4 con respecto a la versi√≥n 3.x

![Tutorial desarrollo de un API REST con NodeJS, Express y MongoBD](/images/como-crear-una-api-rest-usando-node-js/tutorial-api-res-node-js-express-mongo-mongoose.png)

Esto es importante En la versi√≥n 4, varios _middlewares_ fueron eliminados de Express y ahora son dependencias separadas, como es el caso de _bodyParser, compress, logger, session, favicon, methodOverride, etc‚Ä¶_

Ya no se encuentran dentro del paquete *Express*¬†y¬†hay que importarlos como un m√≥dulo aparte si tenemos pensado utilizarlos. De esta manera _Express_ es ahora un m√≥dulo m√°s ligero.

## Desarrollando nuestro API RESTful

### Iniciando el proyecto

El primer paso es crear un directorio en tu entorno local para la aplicaci√≥n, e iniciar un repositorio para guardar los cambios y que luego podamos desplegarlo por ejemplo en Heroku. Yo personalmente uso [Git](http://git-scm.com/) porque es una maravilla de la creaci√≥n y porque a Heroku es lo que le mola ;)

```js
$ mkdir node-api-rest-example
$ cd node-api-rest-example
$ git init
```

Antes de empezar, necesitas tener Node instalado en tu ordenador, para que funcione en tu entorno local de desarrollo. Para ello si tienes Mac te recomiendo que lo hagas de la siguiente manera:

```js
$ brew update
$ brew install node
```

Puede que lleve unos minutos mientras se descargan los paquetes. Una vez tengas node instalado, podemos empezar :)

El primer c√≥digo que necesitamos escribir en una aplicaci√≥n basada en Node es el archivo `package.json`. √âste archivo nos indica que dependencias vamos a utilizar en ella. Este archivo va en el directorio ra√≠z de la aplicaci√≥n:

Por lo tanto `package.json` tendr√°:

```js
{
 "name": "node-api-rest-example",
 "version": "2.0.0",
 "dependencies": {
 "mongoose": "~3.6.11",
 "express": "^4.7.1",
 "method-override": "^2.1.2",
 "body-parser": "^1.5.1"
 }
}
```

Y ahora para descargar las dependencias escribimos lo siguiente en la consola y NPM (el gestor de paquetes de Node) se encargar√° de instalarlas.

```shell
$ npm install
```

### Nuestro servidor Node.js

Con todo listo, podemos comenzar a _codear_ de verdad. Creamos un fichero llamado `app.js` en el directorio ra√≠z que ser√° el que ejecute nuestra aplicaci√≥n y arranque nuestro server. Crearemos en primer lugar un sencillo servidor web para comprobar que tenemos todo lo necesario instalado, y a continuaci√≥n iremos escribiendo m√°s c√≥digo.

```js
var express = require("express"),
  app = express(),
  bodyParser = require("body-parser"),
  methodOverride = require("method-override");
mongoose = require("mongoose");

app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
app.use(methodOverride());

var router = express.Router();

router.get("/", function (req, res) {
  res.send("Hello World!");
});

app.use(router);

app.listen(3000, function () {
  console.log("Node server running on http://localhost:3000");
});
```

¬øQu√© hace este c√≥digo? Muy sencillo, las primeras l√≠neas se encargan de incluir las dependencias que vamos a usar, algo as√≠ como los includes en C o PHP, o los import de Python. Importamos [Express](http://expressjs.com/) para facilitarnos crear el servidor y realizr llamadas HTTP. Con `http` creamos el servidor que posteriormente escuchar√° en el puerto 3000 de nuestro ordenador (O el que nosotros definamos).

Con `bodyParser` permitimos que pueda _parsear_ JSON, `methodOverride()` nos permite implementar y personalizar m√©todos HTTP.

Podemos declarar las rutas con `app.route(nombre_de_la_ruta)` seguido de los verbos `.get()`, `.post()`, etc‚Ä¶ y podemos crear una instancia para ellas con `express.Router()`. En este primer ejemplo vamos hacer que s√≥lo reciba una petici√≥n `GET` del navegador y muestre en el mismo la frase `Hello World`

Para ejecutar este peque√±o c√≥digo s√≥lo tienes que escribir en consola lo siguiente y abrir un navegador con la url [http://localhost:3000](http://localhost:3000)

```js
$ node app.js
Node server running on http://localhost:3000
```

Si todo va bien, esto es lo que se ver√°:

![Tutorial de NodeJS creando API REST - Hello World Node](/images/como-crear-una-api-rest-usando-node-js/tutorial_api_rest_en_node-holamundo.png)

Y como usamos GIT, no hay que olvidarse de hacer _commit_ de nuestro c√≥digo. Puedes descargar el c√≥digo fuente de este proyecto en el [repositorio que tengo en GitHub](https://github.com/carlosazaustre/node-api-rest-example/tree/feature-express4)

```js
$ git add .
$ git commit -m 'Initial commit'
```

### Creando los modelos de nuestra API REST

En esta parte vamos a crear un modelo usando [Mongoose](http://mongoosejs.com/) para poder guardar la informaci√≥n en la base de datos siguiendo el esquema. Como base de datos vamos a utilizar [MongoDB](http://www.mongodb.org/).[ MongoDB es una base de datos Open Source NoSQL orientada a documentos tipo JSON](http://en.wikipedia.org/wiki/MongoDB), lo cual nos viene que ni pintado para entregar los datos en este formato en las llamadas a la API. Si quieres ver un buen resumen de MongoDB te recomiendo [√©sta presentaci√≥n de **Israel Gutierrez**](http://www.slideshare.net/gootyfer/full-metal-mongo) (amigo y profe) que incluye las nociones b√°sicas.

Para este ejemplo vamos a crear una base de datos de series de TV, por tanto vamos a crear un modelo (Archivo: `models/tvshow.js`) que incluya la informaci√≥n de una serie de TV, como pueden ser su t√≠tulo, el a√±o de inicio, pa√≠s de producci√≥n, una imagen promocional, n√∫mero de temporadas, g√©nero y resumen del argumento:

```js
var mongoose = require("mongoose"),
  Schema = mongoose.Schema;

var tvshowSchema = new Schema({
  title: { type: String },
  year: { type: Number },
  country: { type: String },
  poster: { type: String },
  seasons: { type: Number },
  genre: {
    type: String,
    enum: ["Drama", "Fantasy", "Sci-Fi", "Thriller", "Comedy"],
  },
  summary: { type: String },
});

module.exports = mongoose.model("TVShow", tvshowSchema);
```

Con esto ya podemos implementar la conexi√≥n a la base de datos en el archivo `app.j`\* a√±adiendo las siguientes l√≠neas:

```js
var mongoose = require("mongoose");
mongoose.connect("mongodb://localhost/tvshows");
```

Quedando as√≠ el c√≥digo de _app.js_:

```js
var express = require("express"),
  app = express(),
  http = require("http"),
  server = http.createServer(app),
  mongoose = require("mongoose");

app.use(bodyParser.urlencoded({ extended: false }));
app.use(bodyParser.json());
app.use(methodOverride());

var router = express.Router();

router.get("/", function (req, res) {
  res.send("Hello World!");
});

app.use(router);

mongoose.connect("mongodb://localhost/tvshows", function (err, res) {
  if (err) {
    console.log("ERROR: connecting to Database. " + err);
  }
  app.listen(3000, function () {
    console.log("Node server running on http://localhost:3000");
  });
});
```

Para que esto funcione en nuestro entorno local, necesitamos tener instalado MongoDB. Dependiendo de vuestro sistema operativo de hace de una forma u otra. [Aqu√≠ ten√©is la documentaci√≥n oficial](http://docs.mongodb.org/manual/tutorial/install-mongodb-on-os-x/). Si tienes Mac, se instala de la misma manera que Node.js:

```shell
$ brew update
$ brew install mongodb
```

Una vez hecho esto, para poder iniciar MongoDB debes ejecutar en otra terminal:

```js
$ mongod
all output going to: /usr/local/var/log/mongodb/mongo.log
```

Con Mongo arrancado ya podemos ejecutar la aplicaci√≥n como en la parte anterior con `node app.js` desde la terminal, si todo va bien tendremos algo en la pantalla como esto:

```js
$ node app.js
Node server running on http://localhost:3000
Connected to Database
```

Ahora desde otra terminal, podemos entrar al shell de MongoDB y comprobar que la base de datos se ha creado correctamente. Para ello ejecutamos el comando `mongo`

```js
$ mongo
MongoDB shell version: 2.4.1
connecting to: test
> use tvshows
switched to db tvshows
> show dbs
local	0.078125GB
tvshows	(empty)
>_
```

Ya tenemos todo configurado y listo para albergar los datos, s√≥lo nos queda crear las rutas que definir√°n las llamadas a la API para poder guardar y consultar la informaci√≥n

### Implementando los controladores de nuestas rutas o _endpoints_

los controladores de las rutas de nuestro API los vamos a crear en un archivo separad que llamaremos `controllers/tvshows.js`. Gracias a `exports` conseguimos modularizarlo y que pueda ser llamado desde el archivo principal de la aplicaci√≥n. El c√≥digo de a continuaci√≥n es el comienzo del archivo con la primera funci√≥n que ser√° la que devuelva todos los registros almacenados:

```js
//File: controllers/tvshows.js
var mongoose = require("mongoose");
var TVShow = mongoose.model("TVShow");

//GET - Return all tvshows in the DB
exports.findAllTVShows = function (req, res) {
  TVShow.find(function (err, tvshows) {
    if (err) res.send(500, err.message);

    console.log("GET /tvshows");
    res.status(200).jsonp(tvshows);
  });
};
```

De esta manera tan sencilla, al llamar a la funci√≥n `findAllTVShows` se envia como respuesta toda la colecci√≥n de `tvshows` almacenada y en formato [JSON](http://www.json.org/). Si queremos que s√≥lo nos devuelva un registro con un identificador √∫nico, tenemos que crear una funci√≥n tal que la siguiente:

```js
//GET - Return a TVShow with specified ID
exports.findById = function(req, res) {
	TVShow.findById(req.params.id, function(err, tvshow) {
    if(err) return res.send(500. err.message);

    console.log('GET /tvshow/' + req.params.id);
		res.status(200).jsonp(tvshow);
	});
};
```

Con las funciones `find()` y `findById()` podemos buscar en la base de datos a partir de un modelo. Ahora desarrollar√© el resto de funciones que permiten insertar, actualizar y borrar registros de la base de datos. La funci√≥n de a continuaci√≥n ser√≠a la correspondiente al m√©todo POST y lo que hace es a√±adir un nuevo objeto a la base de datos:

```js
//POST - Insert a new TVShow in the DB
exports.addTVShow = function (req, res) {
  console.log("POST");
  console.log(req.body);

  var tvshow = new TVShow({
    title: req.body.title,
    year: req.body.year,
    country: req.body.country,
    poster: req.body.poster,
    seasons: req.body.seasons,
    genre: req.body.genre,
    summary: req.body.summary,
  });

  tvshow.save(function (err, tvshow) {
    if (err) return res.status(500).send(err.message);
    res.status(200).jsonp(tvshow);
  });
};
```

Primero creamos un nuevo objeto `tvshow` siguiendo el patr√≥n del modelo, recogiendo los valores del cuerpo de la petici√≥n, lo salvamos en la base de datos con el comando `.save()` y por √∫ltimo lo enviamos en la respuesta de la funci√≥n.

La siguiente funci√≥n nos permitir√° actualizar un registro a partir de un ID. Primero buscamos en la base de datos el registro dado el ID, y actualizamos sus campos con los valores que devuelve el cuerpo de la petici√≥n:

```js
//PUT - Update a register already exists
exports.updateTVShow = function (req, res) {
  TVShow.findById(req.params.id, function (err, tvshow) {
    tvshow.title = req.body.petId;
    tvshow.year = req.body.year;
    tvshow.country = req.body.country;
    tvshow.poster = req.body.poster;
    tvshow.seasons = req.body.seasons;
    tvshow.genre = req.body.genre;
    tvshow.summary = req.body.summary;

    tvshow.save(function (err) {
      if (err) return res.status(500).send(err.message);
      res.status(200).jsonp(tvshow);
    });
  });
};
```

Y por √∫ltimo para completar la funcionalidad CRUD de nuestra API, necesitamos la funci√≥n que nos permita elminar registros de la base de datos y eso lo podemos hacer con el c√≥digo de a continuaci√≥n:

```js
//DELETE - Delete a TVShow with specified ID
exports.deleteTVShow = function (req, res) {
  TVShow.findById(req.params.id, function (err, tvshow) {
    tvshow.remove(function (err) {
      if (err) return res.status(500).send(err.message);
      res.status(200).send();
    });
  });
};
```

Como puedes ver, usamos de nuevo el m√©todo `.findById()` para buscar en la base de datos y para borrarlo usamos `.remove()` de la misma forma que usamos el `.save()` para salvar.

Ahora tenemos que unir estas funciones a las peticiones que ser√°n nuestras llamadas al API. Volvemos a nuestro archivo principal, `app.js` y declaramos las rutas, siguiendo las pautas de Express v.4

```js
var TVShowCtrl = require("./controllers/tvshows");

// API routes
var tvshows = express.Router();

tvshows
  .route("/tvshows")
  .get(TVShowCtrl.findAllTVShows)
  .post(TVShowCtrl.addTVShow);

tvshows
  .route("/tvshows/:id")
  .get(TVShowCtrl.findById)
  .put(TVShowCtrl.updateTVShow)
  .delete(TVShowCtrl.deleteTVShow);

app.use("/api", tvshows);
```

El archivo completo [**controllers/tvshows.js**](https://github.com/carlosazaustre/node-api-rest-example/blob/feature-express4/controllers/tvshows.js) lo puedes ver y descargar [desde el repositorio en GitHub](https://github.com/carlosazaustre/node-api-rest-example/blob/feature-express4/controllers/tvshows.js).

#### Probando nuestro API REST en el navegador

A continuaci√≥n voy a probar una herramienta online que nos permite _jugar_ con las llamadas al API y poder consultar y almacenar datos para probarla y ver su funcionamiento un poco m√°s claro.

Para ello nos dirijimos a [restconsole.com](http://restoconsole.com) que es una extensi√≥n de [Google Chrome](https://www.google.com/intl/en/chrome/browser/), que permite hacer lo que queremos de una manera visual y sencilla.

![Tutorial desarrollo de un API REST con NodeJS - REST Console](/images/como-crear-una-api-rest-usando-node-js/tutorial_api_rest_en_node-restconsole.png)

Antes de probarlo, debemos tener mongo y el servidor node de nuestra app corriendo. Una vez hecho esto introducimos los siguientes datos para hacer una llamada POST que almacene un registro en la base de datos.

- **Target**: http://localhost:3000/tvshow (D√≥nde est√° ejecut√°ndose la aplicaci√≥n y la llamada al m√©todo POST que hemos programado)
- **Content-Type**: application/json (en los dos input que nos dan)
- **Request-Payload**: Aqu√≠ va el cuerpo de nuestra petici√≥n, con el objeto JSON siguiente (por ejemplo):

```js
{
  "title": "LOST",
  "year": 2004,
  "country": "USA",
  "poster": "http://ia.media-imdb.com/images/M/MV5BMjA3NzMyMzU1MV5BMl5BanBnXkFtZTcwNjc1ODUwMg@@._V1_SY317_CR17,0,214,317_.jpg",
  "seasons": 6,
  "genre": "Sci-Fi",
  "summary": "The survivors of a plane crash are forced to live with each other on a remote island, a dangerous new world that poses unique threats of its own."
}
```

![Tutorial desarrollo de un API REST con NodeJS REST Console POST](/images/como-crear-una-api-rest-usando-node-js/tutorial_api_rest_en_node-restconsole-post.png)

Pulsamos `SEND` y si todo va bien, la petici√≥n se realizar√° y abajo de la aplicaci√≥n _REST Console_ veremos algo como esto:

![Tutorial desarrollo de un API REST con NodeJS - REST Console Response a POST](/images/como-crear-una-api-rest-usando-node-js/tutorial_api_rest_en_node-restconsole-response.png)

¬øC√≥mo comprobamos si se ha guardado en nuestra base de datos? Muy sencillo, en nuestro terminal ejecutamos el Shell de mongo con el comando `mongod` e introducimos los siguiente comandos:

```shell
$ mongo
MongoDB shell version: 2.4.1
connecting to: test
> show databases
tvshows	0.203125GB
> use tvshows
switched to db tvshows
> show collections
system.indexes
tvshows
> db.tvshows.find()
{ "title" : "LOST", "year" : 2004, "country" : "USA", "poster" : "http://ia.media-imdb.com/images/M/MV5BMjA3NzMyMzU1MV5BMl5BanBnXkFtZTcwNjc1ODUwMg@@._V1_SY317_CR17,0,214,317_.jpg", "seasons" : 6, "genre" : "Sci-Fi", "summary" : "The survivors of a plane crash are forced to live with each other on a remote island, a dangerous new world that poses unique threats of its own.", "_id" : ObjectId("51b44d7899ac57fb18000002"), "__v" : 0 }

```

Y ahi la tenemos, puedes probar a introducir alguna m√°s, para tener mayor contenido con el que probar. Una vez introduzcas varios registros, puedes probar a llamarlos a trav√©s de la petici√≥n GET que hemos preparado: `http://localhost:3000/tvshows` la cu√°l te mostrar√° algo parecido a esto:

![Tutorial de NodeJS, creando un API REST - Petici√≥n GET](/images/como-crear-una-api-rest-usando-node-js/tutorial_api_rest_en_node-response_get.png)
Tambi√©n podemos llamar a un s√≥lo registro gracias a la petici√≥n `GET tvshows/:id` que programamos, si ejecutamos por ejemplo **http://localhost:3000/tvshow/51b44d7899ac57fb18000002** nos devolver√° un √∫nico objeto:

![Tutorial de NodeJS, creando un API REST - Petici√≥n GET con ID ](/images/como-crear-una-api-rest-usando-node-js/tutorial_api_rest_en_node-response-get-id.png)

Los m√©todos restantes `PUT` y `DELETE` funcionan de manera parecida al `POST` s√≥lo que hay que pasarte el valor del ID del objeto que queremos actualizar o borrar. Te invito a que lo pruebes en la [Tutorial de NodeJS, creando un API REST - REST Console](http://restconsole.com).

Con esto tendr√≠amos el funcionamiento b√°sico y programaci√≥n de lo que ser√≠a una API REST. Como puedes ver es bastante sencillo y utilizas Javascript en todas partes, como lenguaje de servidor ([Node](http://nodejs.org)), como formato de datos ([JSON](http://json.org)) y como base de datos ([MongoDB](http://www.mongodb.org/))

A continuaci√≥n te dejo una serie de video tutoriales de [mi canal de YouTube](https://www.youtube.com/user/azaman1984) sobre √©ste tema

> Todo el c√≥digo utilizado est√° subido en el[ repositorio que he creado en GitHub](https://github.com/carlosazaustre/node-api-rest-example/tree/feature-express4), te animo a descargarlo, probarlo y modificarlo para aprender :)
