---
title: "C√≥mo relacionar tus modelos en MongoDB"
date: "2015-01-18"
tags:
  - "üíª Desarrollo"
---

MongoDB es una base de datos no relacional, es decir no es como las t√≠picas bases de datos SQL (MySQL, Oracle, PostgreSQL, etc...) donde existen relaciones entre una tabla y otra. Veamos un ejemplo cl√°sico.

Imaginemos una base de datos de libros. Tendr√≠amos una tabla con los t√≠tulos de los libros y otra con los datos de los autores. El campo `autor` en la tabla de libros, apuntar√≠a a un ID o clave primaria de un autor de la tabla autores.

En MongoDB podemos hacer algo parecido, por medio de referencias y el [m√©todo `populate` de MongoDB](http://mongoosejs.com/docs/populate.html).

Sigamos con el ejemplo anterior. Un modelo `autor` en Node.js usando `mongoose` ser√≠a tal que as√≠:

```javascript
var mongoose = require("mongoose");
var Schema = mongoose.Schema;

var autorSchema = new Schema({
  nombre: String,
  biografia: String,
  fecha_de_nacimiento: Date,
  nacionalidad: String,
});

module.exports = mongoose.model("Autor", autorSchema);
```

y supongamos un modelo sencillo para `libro` de la siguiente manera:

```javascript
var mongoose = require('mongoose');
var Schema = mongoose.Schema;
var Autor = mongoose.model('Autor');

var libroSchema = new Schema({
	titulo: String
    paginas: Number,
    isbn: String,
    autor: { type: Schema.ObjectId, ref: "Autor" }
});

module.exports = mongoose.model("Libro", libroSchema);
```

Si nos fijamos, para el campo `autor` en el modelo `libro` hemos usado el tipo `Schema.ObjectId` y la referencia al modelo `Autor`. Esto nos permitir√° establecer la relaci√≥n entre un campo de una tabla y otra.

Pero si no tenemos consultas SQL, y pedimos una lista de todos los libros en la base de datos ¬øQu√© datos nos llegar√°n?

Lo primero que programar√≠amos ser√≠a esto (en Express/Node.js):

```javascript
app.get("/libros", function (req, res) {
  Libro.find({}, function (err, libros) {
    res.status(200).send(libros);
  });
});
```

y si tenemos varios libros registrados en la base de datos, nos devolver√≠a un `JSON` parecido a este:

```javascript
[{
    "_id": "547db17cbe9956a000001",
    "__v": 0
    "titulo": "Juego de Tronos",
    "paginas": 150,
    "isbn": "0-553-57340-4",
    "autor": "547db17cbe9958b000001"
},
{
    "_id": "547db17cbe9956a000001",
    "__v": 0
    "titulo": "Choque de Reyes",
    "paginas": 340,
    "isbn": "0-553-57340-5",
    "autor": "547db17cbe9958b000001"
},
{
    "_id": "547db17cbe9956a000001",
    "__v": 0
    "titulo": "Tormenta de Espadas",
    "paginas": 620,
    "isbn": "0-553-57340-7",
    "autor": "547db17cbe9958b000001"
}]
```

En el campo `autor` obtenemos la referencia en formato `ObjectID` del autor, pero no su ficha completa. ¬øQu√© pasa si queremos mostrar en un s√≥lo `JSON` toda la informaci√≥n para poder pintarla de una sola llamada en nuestra webapp? Para eso necesitamos hacer uso del m√©todo `populate` de MongoDB que tambi√©n implementa la librer√≠a `mongoose`.

En nuestro controlador anterior, debemos ampliarlo con lo siguiente:

```javascript
app.get("/libros", function (req, res) {
  Libro.find({}, function (err, libros) {
    Autor.populate(libros, { path: "autor" }, function (err, libros) {
      res.status(200).send(libros);
    });
  });
});
```

La l√≠nea `Autor.populate(libros, {path: "autor"},...);` toma el array de objectos `libros` y le indica que en la ruta `autor` lo "popule" con los datos del modelo `Autor`. Quedando una respuesta m√°s completa como este ejemplo:

```javascript
[{
    "_id": "547db17cbe9956a000001",
    "__v": 0
    "titulo": "Juego de Tronos",
    "paginas": 150,
    "isbn": "0-553-57340-4",
    "autor": {
    	"_id": "547db17cbe9958b000001",
        "__v": 0,
        "nombre": "George R. R. Martin",
        "biografia": "American novelist...",
        "fecha_de_nacimiento": "1948-09-20T00:00:00.000Z",
        "nacionalidad": "USA"
    }
},
{
    "_id": "547db17cbe9956a000001",
    "__v": 0
    "titulo": "Choque de Reyes",
    "paginas": 340,
    "isbn": "0-553-57340-5",
    "autor": {
    	"_id": "547db17cbe9958b000001",
        "__v": 0,
        "nombre": "George R. R. Martin",
        "biografia": "American novelist...",
        "fecha_de_nacimiento": "1948-09-20T00:00:00.000Z",
        "nacionalidad": "USA"
    }
},
{
    "_id": "547db17cbe9956a000001",
    "__v": 0
    "titulo": "Tormenta de Espadas",
    "paginas": 620,
    "isbn": "0-553-57340-7",
    "autor": {
    	"_id": "547db17cbe9958b000001",
        "__v": 0,
        "nombre": "George R. R. Martin",
        "biografia": "American novelist...",
        "fecha_de_nacimiento": "1948-09-20T00:00:00.000Z",
        "nacionalidad": "USA"
    }
}]
```

Podemos ver que el objeto `_id` del campo `autor` ha sido sustituido por el modelo `autor` completo al que hace referencia.

De esta manera conseguimos un comportamiento parecido al t√≠pico relacional en las bases de datos SQL en MongoDB.
