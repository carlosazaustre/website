---
title: "Ejecuta tu App NodeJS como un Servicio en Linux"
date: "2016-03-04"
tags:
  - " Desarrollo"
---

Imagina que tienes una App escrita en Node.js y necesitas desplegarla en producci贸n.

Ya sabes que con el comando `node app.js` no es una buena opci贸n, ya que si la aplicaci贸n se cae no hay manera de volverlo a arrancar autom谩ticamente. Necesitar铆as entrar en el servidor y correr el comando de nuevo.

Hay opciones como `forever` y `pm2` que te permiten tener tu aplicaci贸n Node corriendo continuamente y reiniciarse en caso de ca铆da.

Sin embargo una opci贸n m谩s elegante es correr tu aplicaci贸n como servicio en tu sistema operativo. Como corre por ejemplo Nginx o MongoDB.

En este art铆culo vemos como hacerlo para Linux (En concreto para Ubuntu) utilizando **upstart**.

![Upstart](/image/saplicacion-node-como-servicio-upstart/upstart80.png)

[_Upstart_](https://es.wikipedia.org/wiki/Upstart) es un _demonio_ basado en eventos que maneja el arranque de tareas y servicios durante el arranque del sistema, los detiene en el apagado y los supervisa mientras el sistema est谩 funcionando. Originalmente fue desarrollado para las distribuciones Ubuntu pero se pretende que sea adecuado para su implementaci贸n en todas las distribuciones Linux.

Tienes m谩s informaci贸n en la p谩gina del proyecto [upstart](http://upstart.ubuntu.com/)

## Tu aplicaci贸n Node

Partamos de una aplicaci贸n Node.js muy simple. El siguiente c贸digo nos sirve:

```javascript
// app.js
var express = require("express");
var app = express();
var port = process.env.PORT;

app.get("/", function (req, res) {
  res.send("Hola Mundo!");
});

app.listen(port);
```

Y este ser铆a el fichero `package.json`:

```javascript
{
  "name": "mi-aplicacion",
  "version": "1.0.0",
  "dependencies": {
     "express": "^4.13.3"
  },
  "scripts": {
     "start": "node app.js"
  }
}
```

sta aplicaci贸n simplemente muestra en el navegador `Hola Mundo!` cuando entramos a la URL principal (por ejemplo: `http://dominio.com/:port`) Siendo `port` el valor que recoja de una variable de entorno `PORT`.

## Fichero de configuraci贸n Upstart

Creamos un fichero de configuraci贸n de _upstart_ llamado `miAplicacion.conf` con el siguiente c贸digo:

```shell
start on runlevel [2345]
stop on runlevel [!2345]

respawn
respawn limit 10 5

setuid ubuntu
chdir /opt/myAplicacion

env PORT=3000

exec npm start
```

Explicamos l铆nea a l铆nea que hace este fichero.

Los sistemas operativos tipo UNIX tienen diferentes [niveles de ejecuci贸n](https://es.wikipedia.org/wiki/Nivel_de_ejecuci%C3%B3n) (_runlevels_). Los 7 niveles de ejecuci贸n del sistema son:

- **0**: Nivel Alto: Para el apagado del sistema
- **1**: Nivel de usuario 煤nico.
- **2**: Nivel de modo multiusuario. (sin soporte de red).
- **3**: Nivel de modo multiusuario con soporte de red
- **4**: Igual que el Nivel 3.
- **5**: Igual que el Nivel 3 con soporte gr谩fico.
- **6**: Reinicia el sistema

En este caso vamos a asociarle los niveles `2`, `3`, `4` y `5`. con `start on runlevel [2345]` y `stop on runlevel ![2345]`

El comando`respawn` nos ayuda a que el servicio se reinicie en caso de que se caiga y con `respawn limit 10 5` le indicamos que no reinicie m谩s de 5 veces en 10 segundos. Esto nos sirve para que no se quede en un bucle de reinicios en caso de que haya un malfuncionamiento de la aplicaci贸n. S贸lo se reiniciar谩 si es una ca铆da puntual.

Con `setuid ubuntu` indicamos que usuario ejecuta la aplicaci贸n. Es conveniente que este usuario no sea root, es m谩s recomendable por seguridad crear un usuario del sistema operativo con permisos limitados para ejecutar la aplicaci贸n. En este caso el usuario es `ubuntu`

El siguiente paso es indicar en que directorio o carpeta del sistema est谩 el c贸digo de nuestra aplicaci贸n node. Puede ser cualquiera pero es una buena opci贸n tenerlo en la ruta `/opt/miAplicacion` siendo `miAplicacion` el nombre de nuestro proyecto.

A continuaci贸n podemos _setear_ variables de entorno, como por ejemplo si estamos en producci贸n o desarrollo, el puerto, claves secretas de APIs, etc... lo podemos hacer con el comando `env` seguido de la variable de entorno, un igual y el valor: `env PORT=3000`, con esto la variable de entorno `PORT` queda igualada a `3000` y la aplicaci贸n correr谩 en el puerto 3000.

Por 煤ltimo con el comando `exec` ejecutamos un comando. En este caso ejecutaremos el comando `npm start` que tenemos definido en el `package.json`.

(Internamente `npm start` llama al comando `node app.js` que tenemos configurado en el objeto `scripts` del `package.json`)

## Despliegue

Por 煤ltimo, para hacer funcionar todo, necesitas tener el c贸digo de tu aplicaci贸n node (el `app.js` y el `package.json`) en la carpeta `/opt/miAplicacion` de tu servidor.

Tener un usuario del sistema llamado `ubuntu` o el que tu prefieras, pero a ser posible que no sea `root`.

Y copiar el fichero de configuraci贸n `miAplicacion.conf` en la carpeta `/etc/init/` del sistema que es donde se encuentran los servicios upstart.

Ya solo necesitas ejecutar el comando `service miAplicacion start` en tu servidor y tendr谩s tu aplicaci贸n node.js corriendo como servicio en producci贸n.
